---
title: "ARIMA"
author: "Юрченков Иван Александрович"
date: "15 04 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(quantmod)
```

```{r}
quantmod::getSymbols(Symbols = "AAPL")
```



```{r}
ts.df <- data.frame(get("AAPL"))
ts.df$Date <- as.Date.character(rownames(ts.df), format = "%Y-%m-%d")
ts.df$Num_Date <- as.numeric(ts.df$Date)
head(ts.df)
```


```{r}
plot(x = ts.df$Date, y = log(ts.df$AAPL.Close), type = "o")
grid()
```


Вытаскиваю из графика линейный тренд


```{r}
Y <- log(ts.df$AAPL.Close)
X <- ts.df$Num_Date
model_lm <- lm(Y ~ X)
model_lm
```

```{r}
plot(X, Y, type = "o", col = "blue3", pch = 19, cex = I(0.5))
abline(a = model_lm$coefficients[1], b = model_lm$coefficients[2], col ="red")
grid()
```


```{r}
Y_w_t <- Y - model_lm$coefficients[1] - model_lm$coefficients[2] * X
plot(x = X, y = Y_w_t, col = "purple", type = "o", cex = I(0.5), pch = 19)
```


```{r}
N = 120
arima_model <- arima(x = Y_w_t[1:(length(Y_w_t) - 120)], order = c(30, 0, 0))
```

```{r}
arima_model
```

```{r}

preds = predict(arima_model, n.ahead = 120)

plot(c(Y_w_t[1:(length(Y_w_t) - 120)], as.numeric(preds$pred)), 
     type = "o", 
     col = "red", 
     cex = I(0.5), 
     xlim = c(3000, 4000))
lines(Y_w_t, 
      type = "o", 
      col = "blue", 
      cex = I(0.5))
```

```{r}
length(as.matrix(ts.df$AAPL.Close)[1:(1 + 10 + 1), 1])
```


```{r}
sliding_window <- function(numeric_vector, window_elements = 10) {
  rows_matrix <- length(numeric_vector) - window_elements + 1
  cols_matrix <- window_elements
    
  result_matrix <- matrix(nrow = rows_matrix, ncol = cols_matrix)
  
  for (index in 1:rows_matrix) {
    result_matrix[index, ] <- numeric_vector[index:(index - 1 + window_elements)]   
  }
  
  return(result_matrix)
}
```


```{r}
lin_reg <- function(X, y) {
  X <- cbind(1, as.matrix(X))
  y <- as.matrix(y)
  w <- pracma::inv(t(X) %*% X) %*% t(X) %*% y
  fit <- X %*% w
  
  rownames(w)[1] <- "bias"
  return(list(parameters = w, fiited = fit))
}


lin_reg_ridge <- function(X, y, alpha = 0) {
  X <- cbind(1, as.matrix(X))
  y <- as.matrix(y)
  w <- pracma::inv(t(X) %*% X + alpha * diag(1, nrow = ncol(X))) %*% t(X) %*% y
  fit <- X %*% w
  
  rownames(w)[1] <- "bias"
  return(list(parameters = w, fiited = fit))
}

```


```{r}
model <- lin_reg(mtcars[, c(1, 3, 4)], mtcars[, c(5, 6)])
model_ridge <- lin_reg_ridge(mtcars[, c(1, 3, 4, 5, 6)], mtcars[, c(7)], alpha = 0.2)

plot(mtcars$wt, mtcars$qsec, col = "blue", cex = I(0.8), pch = 8)
points(mtcars$wt, model_ridge$fiited[, 1], col = "green2", cex = I(0.8), pch = 7)
segments(x0 = mtcars$wt, x1 = mtcars$wt, y0 = mtcars$qsec, y1 = model_ridge$fiited[, 1], col = "green", lwd = I(0.5))

plot(model_ridge$fiited[, 1], mtcars$qsec, col = "blue", cex = I(0.8), pch = 8)
lines(model_ridge$fiited[, 1], model_ridge$fiited[, 1], col = "red", lwd = I(0.6))
segments(x0 = model_ridge$fiited[, 1], x1 = model_ridge$fiited[, 1], y0 = mtcars$qsec, y1 = model_ridge$fiited[, 1], col = "green", lwd = I(0.5))
```



```{r}
cut_window <- function(data, history = 10, forward = 1) {
    rows <- nrow(data) - history - forward
    result_matrix <- matrix(nrow = rows, ncol = history + forward)
    for (index in 1:rows) {
        result_matrix[index, ] <- data[index:(index - 1 + history + forward), 1]
    }
    return(result_matrix)
}


his = 40
forwd = 5
data_X <- cut_window(data = as.matrix(ts.df$AAPL.Close), history = his, forward = forwd)
X <- cbind(1, data_X[,1:his])
Y <- data_X[,(his+1):(his + forwd)]

w = pracma::pinv(t(X) %*% X) %*% t(X) %*% Y
w
```

