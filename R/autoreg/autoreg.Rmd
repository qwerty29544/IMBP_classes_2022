---
title: "ARIMA"
author: "Юрченков Иван Александрович"
date: "15 04 2022"
mainfont: 'Noto Sans'
output: 
  pdf_document: 
    toc: yes
    fig_width: 8
    fig_height: 8
    fig_caption: yes
    number_sections: yes
    latex_engine: xelatex
    highlight: haddock
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## **Загрузка данных с yahoo.finance**


```{r}
library(quantmod)
```

```{r}
quantmod::getSymbols(Symbols = "AAPL")
```



```{r}
ts.df <- data.frame(get("AAPL"))
ts.df$Date <- as.Date.character(rownames(ts.df), format = "%Y-%m-%d")
ts.df$Num_Date <- as.numeric(ts.df$Date)
head(ts.df)
```



```{r}
plot(x = ts.df$Date, y = log(ts.df$AAPL.Close), type = "o")
grid()
```


Вытаскиваю из графика линейный тренд


```{r}
Y <- log(ts.df$AAPL.Close)
X <- ts.df$Num_Date
model_lm <- lm(Y ~ X)
model_lm
```

```{r}
plot(X, Y, type = "o", col = "blue3", pch = 19, cex = I(0.5))
abline(a = model_lm$coefficients[1], b = model_lm$coefficients[2], col ="red")
grid()
```


```{r}
Y_w_t <- Y - model_lm$coefficients[1] - model_lm$coefficients[2] * X
plot(x = X, y = Y_w_t, col = "purple", type = "o", cex = I(0.5), pch = 19)
```




```{r}
length(as.matrix(ts.df$AAPL.Close)[1:(1 + 10 + 1), 1])
```


```{r}
sliding_window <- function(numeric_vector, window_elements = 10) {
  rows_matrix <- length(numeric_vector) - window_elements + 1
  cols_matrix <- window_elements
    
  result_matrix <- matrix(nrow = rows_matrix, ncol = cols_matrix)
  
  for (index in 1:rows_matrix) {
    result_matrix[index, ] <- numeric_vector[index:(index - 1 + window_elements)]   
  }
  
  return(result_matrix)
}
```


```{r}
l_norm <- function(numeric_vector, p = 2) {
    return( sum( abs(numeric_vector)^p )^(1/p) )
}


lin_reg <- function(X, y, l2_alpha = 0, batch_size = 0, shuffle = FALSE, alpha = 10e-3, max_iter = 10e4) {
  X <- cbind(1, as.matrix(X))
  y <- as.matrix(y)
  
  if (is.null(colnames(y))) {
      colnames(y) <- paste0("Y", 1:ncol(y))
  }
  
  if (is.null(colnames(X))) {
      colnames(X) <- c("bias", paste0("X", 1:ncol(X)))
  }
  
  if (batch_size == 0) {
    w <- pracma::inv(t(X) %*% X + l2_alpha * diag(1, nrow = ncol(X))) %*% t(X) %*% y      
  } else {
    w <- matrix(data = 1, 
                ncol = ncol(y), 
                nrow = ncol(X) + 1)
    colnames(w) <- colnames(y)
    rownames(w) <- colnames(X)
    
    
    for (iter in 1:max_iter) {
        for (out_index in 1:ncol(y)) {
            if (shuffle) {
                rows_sample <- sample(x = 1:nrow(X), size = nrow(X), replace = FALSE)
                X[1:nrow(X), ] <- X[rows_sample, ]
            }
            
            # Необходим цикл по батчам
            w[, out_index] = w[, out_index] - alpha    
        }
    }
    
  }
  
  
  
  fit <- X %*% w
  
  rownames(w)[1] <- "bias"
  return(list(parameters = w, fiited = fit))
}

```


```{r}
model <- lin_reg(mtcars[, c(1, 3, 4)], mtcars[, c(5, 6)])
model_ridge <- lin_reg_ridge(mtcars[, c(1, 3, 4, 5, 6)], mtcars[, c(7)], alpha = 0.2)

plot(mtcars$wt, mtcars$qsec, col = "blue", cex = I(0.8), pch = 8)
points(mtcars$wt, model_ridge$fiited[, 1], col = "green2", cex = I(0.8), pch = 7)
segments(x0 = mtcars$wt, x1 = mtcars$wt, y0 = mtcars$qsec, y1 = model_ridge$fiited[, 1], col = "green", lwd = I(0.5))

plot(model_ridge$fiited[, 1], mtcars$qsec, col = "blue", cex = I(0.8), pch = 8)
lines(model_ridge$fiited[, 1], model_ridge$fiited[, 1], col = "red", lwd = I(0.6))
segments(x0 = model_ridge$fiited[, 1], x1 = model_ridge$fiited[, 1], y0 = mtcars$qsec, y1 = model_ridge$fiited[, 1], col = "green", lwd = I(0.5))
```



```{r}
cut_window <- function(data, history = 10, forward = 1) {
    rows <- nrow(data) - history - forward
    result_matrix <- matrix(nrow = rows, ncol = history + forward)
    for (index in 1:rows) {
        result_matrix[index, ] <- data[index:(index - 1 + history + forward), 1]
    }
    return(result_matrix)
}


his = 40
forwd = 5
data_X <- cut_window(data = as.matrix(ts.df$AAPL.Close), history = his, forward = forwd)
X <- cbind(1, data_X[,1:his])
Y <- data_X[,(his+1):(his + forwd)]

w = pracma::pinv(t(X) %*% X) %*% t(X) %*% Y
w
```

